<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>#SinVueltas</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<script>
  document.getElementById("reservaForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const espacioId = document.getElementById("espacioId").value;
    const nombre = document.getElementById("nombre").value;
    const telefono = document.getElementById("telefono").value;

    const response = await fetch("/api/reservar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ espacio_id: espacioId, nombre, telefono })
    });

    const data = await response.json();
    if (response.ok) {
      alert("✅ Reserva enviada correctamente");
      cerrarFormulario();
    } else {
      alert("❌ Error: " + data.error);
    }
  });
</script>

</body>
<body class="bg-blue-950 text-white min-h-screen">

  <!-- Header -->
  <header class="border-b-2 border-yellow-400 p-6 flex justify-between items-center">
    <img src="img/sinvueltass.png" alt="Logo" class="h-14 w-auto"/>
  </header>

  <!-- Main -->
  <main class="px-6 pt-12 pb-20 flex flex-col items-center">
    <h1 class="text-4xl font-semibold text-center mb-4">Busque un lugar sin dar vueltas</h1>
    <p class="text-lg text-gray-300 text-center mb-8">Encuentre estacionamiento rápido y disfrute su día #SinVueltas</p>

    <!-- Selector de pisos -->
    <div class="flex items-center gap-6 mb-6">
      <button id="prevFloor" class="text-2xl hover:text-yellow-400">←</button>
      <span id="currentFloor" class="text-xl font-bold bg-blue-800 px-6 py-2 rounded-lg border-2 border-yellow-400">PB</span>
      <button id="nextFloor" class="text-2xl hover:text-yellow-400">→</button>
    </div>

    <!-- Estadísticas -->
    <div class="bg-white text-gray-900 rounded-xl shadow-md p-6 mb-6 w-full max-w-4xl">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-4">
          <div class="bg-blue-950 p-3 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"></path>
              <circle cx="7" cy="17" r="2"></circle>
              <path d="M9 17h6"></path>
              <circle cx="17" cy="17" r="2"></circle>
            </svg>
          </div>
          <div>
            <h2 class="text-2xl font-bold" id="floorTitle">Planta Baja</h2>
            <p class="text-sm text-gray-500">Haz clic en un espacio para reservar</p>
          </div>
        </div>
        <div class="text-center">
          <div class="text-4xl font-bold" id="availableCount">0</div>
          <div class="text-sm text-gray-500">disponibles</div>
        </div>
      </div>
    </div>

    <!-- Mapa del estacionamiento -->
    <div class="bg-white text-gray-900 rounded-xl shadow-md p-6 w-full max-w-4xl">
      <div class="flex justify-between mb-4">
        <div class="flex gap-4 text-sm">
          <span class="text-green-600 font-medium"><span id="freeSpaces">0</span> libres</span>
          <span class="text-red-600 font-medium"><span id="occupiedSpaces">0</span> ocupados</span>
        </div>
      </div>
      <div class="bg-gray-100 rounded-lg p-6">
        <div class="flex gap-8 justify-center">
          <div id="leftRow" class="flex flex-col gap-3"></div>
          <div class="w-20 border-l-2 border-r-2 border-dashed border-gray-300 flex items-center justify-center">
            <div class="text-xs text-gray-400 font-medium">VÍA</div>
          </div>
          <div id="rightRow" class="flex flex-col gap-3"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Formulario emergente -->
  <div id="formularioReserva" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
    <div class="bg-white text-gray-900 p-6 rounded-lg w-80">
      <h2 class="text-xl font-bold mb-4">Reservar espacio</h2>
      <form id="reservaForm">
        <input type="hidden" id="espacioId" />
        <label class="block mb-2 text-sm">Nombre completo</label>
        <input type="text" id="nombre" required class="w-full mb-4 p-2 border rounded" />
        <label class="block mb-2 text-sm">Número de celular</label>
        <input type="text" id="telefono" required class="w-full mb-4 p-2 border rounded" />
        <div class="flex justify-between">
          <button type="submit" class="bg-yellow-400 text-black px-4 py-2 rounded hover:bg-yellow-500">Reservar</button>
          <button type="button" onclick="cerrarFormulario()" class="text-red-600">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Script -->
  <script>
    const floors = ['PB', 'P1', 'P2'];
    const floorNames = { PB: 'Planta Baja', P1: 'Primer Piso', P2: 'Segundo Piso' };
    let currentFloorIndex = 0;

    function abrirFormulario(id) {
      document.getElementById('espacioId').value = id;
      document.getElementById('formularioReserva').style.display = 'flex';
    }

    function cerrarFormulario() {
      document.getElementById('formularioReserva').style.display = 'none';
    }

    document.getElementById('reservaForm').onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById('espacioId').value;
      const nombre = document.getElementById('nombre').value;
      const telefono = document.getElementById('telefono').value;

      try {
        await fetch('/api/registrar_chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telefono, chat_id: 'webform:' + nombre })
        });

        const res = await fetch(`/api/reservar/${id}`, { method: 'POST' });
        const data = await res.json();
        alert(data.mensaje || 'Reservado correctamente');
        cerrarFormulario();
        fetchOccupancy();
      } catch (err) {
        alert('Error al reservar');
        console.error(err);
      }
    };

    function createParkingSpot(espacio, label) {
      const spot = document.createElement('div');
      spot.className = 'relative flex flex-col items-center';

      const box = document.createElement('div');
      box.className = `w-14 h-16 rounded-md border-2 flex items-center justify-center font-bold text-white ${espacio.disponible ? 'bg-green-500 border-green-600' : 'bg-red-500 border-red-600'}`;
      box.textContent = label;

      if (espacio.disponible) {
        const btn = document.createElement('button');
        btn.className = 'mt-2 text-xs bg-yellow-400 text-black px-2 py-1 rounded hover:bg-yellow-500';
        btn.textContent = 'Reservar';
        btn.onclick = () => abrirFormulario(espacio.id);
        spot.appendChild(btn);
      }

      spot.appendChild(box);
      return spot;
    }

  async function fetchOccupancy() {
  const res = await fetch('/api/espacios');
  const data = await res.json();
  const espacios = data.espacios;

  const floor = floors[currentFloorIndex];
  const leftRow = document.getElementById('leftRow');
  const rightRow = document.getElementById('rightRow');
  leftRow.innerHTML = '';
  rightRow.innerHTML = '';

  const floorEspacios = espacios.filter(e => e.id >= currentFloorIndex * 8 + 1 && e.id <= currentFloorIndex * 8 + 8);
  const filaIzq = floorEspacios.slice(0, 4);
  const filaDer = floorEspacios.slice(4, 8);

  const disponibles = floorEspacios.filter(e => e.disponible).length;
  const ocupados = floorEspacios.length - disponibles;

  document.getElementById('freeSpaces').textContent = disponibles;
  document.getElementById('occupiedSpaces').textContent = ocupados;
  document.getElementById('availableCount').textContent = disponibles;

  filaIzq.forEach((e, idx) => {
    leftRow.appendChild(createParkingSpot(e, `${floors[currentFloorIndex]}${idx + 1}`));
  });

  filaDer.forEach((e, idx) => {
    rightRow.appendChild(createParkingSpot(e, `${floors[currentFloorIndex]}${idx + 5}`));
  });

  document.getElementById('currentFloor').textContent = floor;
  document.getElementById('floorTitle').textContent = floorNames[floor];
  document.getElementById('floorLetter').textContent = floor;
  document.getElementById('floorName').textContent = floorNames[floor];
}

  document.getElementById('prevFloor').onclick = () => {
      currentFloorIndex = (currentFloorIndex - 1 + floors.length) % floors.length;
      fetchOccupancy();
    };

    document.getElementById('nextFloor').onclick = () => {
      currentFloorIndex = (currentFloorIndex + 1) % floors.length;
      fetchOccupancy();
    };

    fetchOccupancy();
    setInterval(fetchOccupancy, 1000); // actualización automática cada 1  segundos
  </script>
</body>
</html>